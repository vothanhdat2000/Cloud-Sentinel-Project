# Cloud Sentinel - CI: Terraform validate/fmt, Python lint, optional audit
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform fmt check
        run: terraform fmt -check -recursive -diff
        working-directory: infra

      - name: Terraform init
        run: terraform init -backend=false
        working-directory: infra

      - name: Terraform validate
        run: terraform validate
        working-directory: infra

  python:
    name: Python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt ruff

      - name: Ruff check
        run: ruff check infra bot --output-format=github
        continue-on-error: true

      - name: Ruff format check
        run: ruff format --check infra bot
        continue-on-error: true

  # Optional: run Sentinel against LocalStack (proves pipeline can run audit)
  audit:
    name: Audit (LocalStack)
    runs-on: ubuntu-latest
    needs: [terraform, python]
    steps:
      - uses: actions/checkout@v4

      - name: Start LocalStack
        run: |
          cd infra && docker compose up -d
          sleep 15

      - name: Terraform apply
        run: |
          cd infra
          terraform init -backend=false
          terraform apply -auto-approve -input=false
        env:
          TF_VAR_aws_access_key: test
          TF_VAR_aws_secret_key: test

      - name: Seed demo junk and run Sentinel
        run: |
          pip install -r requirements.txt
          cd infra
          export AWS_ACCESS_KEY_ID=test AWS_SECRET_ACCESS_KEY=test
          export LOCALSTACK_ENDPOINT=http://localhost:4566
          python seed_demo_junk.py
          python sentinel.py
        continue-on-error: true
